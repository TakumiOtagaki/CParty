{
  "project_name": "CParty Fixed-Structure Energy",
  "goal": "Refactor CParty safely with regression-first TDD, then add a fixed-structure energy API E(G union G', S) for exact conditional probability workflows.",
  "notes": [
    "This PRD is CParty-only and intentionally excludes parent-repo workflow noise.",
    "Use small, behavior-preserving commits for refactoring steps.",
    "Do not treat CParty CLI -r output as fixed-structure energy ground truth."
  ],
  "execution_policy": {
    "story_selection_policy": {
      "order": "id_ascending",
      "respect_depends_on": true
    },
    "pass_update_policy": {
      "set_passes_true_only_if": [
        "all done_when conditions are satisfied",
        "required artifacts exist or are updated",
        "story test_command passes",
        "full regression command passes"
      ]
    },
    "test_gates": {
      "per_story_required": true,
      "full_regression_after_each_story": true,
      "full_regression_command": "ctest --output-on-failure"
    },
    "checkpoint_policy": {
      "review_checkpoint_every_completed_stories": 3,
      "required_at_checkpoint": [
        "focused_code_review",
        "refactoring_sanity_check",
        "ctest --output-on-failure"
      ]
    },
    "sequence_policy": {
      "allowed_symbols": [
        "A",
        "C",
        "G",
        "U"
      ],
      "t_is_invalid_in_phase2": true
    },
    "default_retry_limit": 2,
    "global_stop_condition": {
      "max_consecutive_identical_failures": 3,
      "max_total_failures": 12,
      "halt_on_signals": [
        "repeated_test_infrastructure_failure",
        "fixture_schema_missing_or_unreadable",
        "build_system_configuration_broken"
      ]
    }
  },
  "numeric_tolerance": {
    "abs_tol": 1e-06,
    "rel_tol": 1e-06
  },
  "user_stories": [
    {
      "id": 1,
      "story": "Add a regression test matrix for existing CParty behavior (with combinations of -p, -k, -d, with/without -r). Focus on non-regression, finite outputs, and deterministic behavior.",
      "depends_on": [],
      "test_command": "ctest --output-on-failure -R regression",
      "retry_limit": 2,
      "done_when": [
        "Regression matrix covers all declared flag combinations.",
        "Determinism and finite-output assertions are present.",
        "ctest filter 'regression' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/*regression*",
        "tests/baselines/*"
      ],
      "passes": true
    },
    {
      "id": 2,
      "story": "Create/normalize fixed-energy fixtures in tests/cparty_fixed_structure_energy/, including PK-free, H-type, K-type, and invalid cases. Ensure every valid case has consistent lengths and parseable structures.",
      "depends_on": [
        1
      ],
      "test_command": "ctest --output-on-failure -R fixtures",
      "retry_limit": 2,
      "done_when": [
        "Fixture schema documented and enforced.",
        "Valid fixtures parse and have matching sequence/structure lengths.",
        "Invalid fixtures are explicitly tagged and tested.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/cparty_fixed_structure_energy/*",
        "tests/cparty_fixed_structure_energy/README*"
      ],
      "passes": true
    },
    {
      "id": 3,
      "story": "Refactor src/pseudo_loop.cc into smaller helper functions (behavior-preserving only). Add tests to prove no numeric regressions on the regression matrix.",
      "depends_on": [
        1
      ],
      "test_command": "ctest --output-on-failure -R pseudo_loop",
      "retry_limit": 2,
      "done_when": [
        "pseudo_loop responsibilities split into helper functions.",
        "Regression matrix remains within abs_tol/rel_tol.",
        "ctest filter 'pseudo_loop' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/pseudo_loop.cc",
        "tests/*pseudo_loop*"
      ],
      "passes": true
    },
    {
      "id": 4,
      "story": "Refactor src/part_func.cc to isolate partition-function path from future fixed-structure path, without changing existing outputs.",
      "depends_on": [
        1
      ],
      "test_command": "ctest --output-on-failure -R part_func",
      "retry_limit": 2,
      "done_when": [
        "Partition-function logic is isolated from fixed-structure hooks.",
        "Existing outputs remain unchanged within abs_tol/rel_tol.",
        "ctest filter 'part_func' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/part_func.cc",
        "tests/*part_func*"
      ],
      "passes": true
    },
    {
      "id": 5,
      "story": "Introduce an internal fixed-structure evaluator that computes E(db_full, seq) in kcal/mol and returns NaN on invalid input. Keep it internal first.",
      "depends_on": [
        2,
        3,
        4
      ],
      "test_command": "ctest --output-on-failure -R fixed_energy_internal",
      "retry_limit": 2,
      "done_when": [
        "Internal evaluator entry point exists and is callable from tests.",
        "Valid cases return finite kcal/mol values.",
        "Invalid inputs return NaN.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*fixed_energy_internal*"
      ],
      "passes": true
    },
    {
      "id": 6,
      "story": "Stage 6a: Expose public API declaration get_structure_energy(seq, db_full) in CPartyAPI (declaration only, no behavior change yet).",
      "depends_on": [
        5
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_decl",
      "retry_limit": 2,
      "done_when": [
        "Public API signature exists in headers.",
        "Build remains source-compatible for existing public APIs.",
        "Full regression command passes."
      ],
      "artifacts": [
        "include/*",
        "tests/*api_structure_energy_decl*"
      ],
      "passes": true
    },
    {
      "id": 7,
      "story": "Stage 6b: Implement API input normalization/validation layer (T->U normalization, length/symbol/structure validation) and enforce NaN contract on invalid input.",
      "depends_on": [
        6
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_validation",
      "retry_limit": 2,
      "done_when": [
        "T->U normalization is implemented at API boundary.",
        "Invalid inputs return quiet NaN and tests use std::isnan.",
        "ctest filter 'api_structure_energy_validation' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*api*",
        "tests/*api_structure_energy_validation*"
      ],
      "passes": true
    },
    {
      "id": 8,
      "story": "Stage 6c-1: Connect API to internal evaluator for PK-free and base can-pair hard constraints.",
      "depends_on": [
        7
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_pkfree",
      "retry_limit": 2,
      "done_when": [
        "API calls internal evaluator for PK-free cases.",
        "Base can-pair hard constraints are enforced.",
        "Valid PK-free fixtures return deterministic finite outputs.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*api_structure_energy_pkfree*"
      ],
      "passes": true
    },
    {
      "id": 9,
      "story": "Stage 6c-2: Extend can-pair hard constraints and evaluator wiring for H-type pseudoknot cases.",
      "depends_on": [
        8
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_h_type",
      "retry_limit": 2,
      "done_when": [
        "H-type cases are evaluated through API->internal path.",
        "Constraint failures are handled predictably as NaN.",
        "ctest filter 'api_structure_energy_h_type' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*api_structure_energy_h_type*"
      ],
      "passes": true
    },
    {
      "id": 10,
      "story": "Stage 6c-3: Extend can-pair hard constraints and evaluator wiring for K-type pseudoknot cases; keep unsupported representability as NaN.",
      "depends_on": [
        9
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_k_type",
      "retry_limit": 2,
      "done_when": [
        "K-type cases are evaluated through API->internal path.",
        "Unsupported representability and invalid structures return NaN.",
        "ctest filter 'api_structure_energy_k_type' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*api_structure_energy_k_type*"
      ],
      "passes": true
    },
    {
      "id": 11,
      "story": "Compatibility and deterministic tests for get_structure_energy: repeated-call equality, finite outputs on valid inputs, and no regressions in existing APIs.",
      "depends_on": [
        10
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_compat",
      "retry_limit": 2,
      "done_when": [
        "Repeated identical calls produce equal outputs within abs_tol/rel_tol.",
        "Existing public API behavior remains compatible.",
        "ctest filter 'api_structure_energy_compat' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/*api_structure_energy_compat*"
      ],
      "passes": true
    },
    {
      "id": 12,
      "story": "Add optional internal EnergyBreakdown diagnostics (debug-only) to help validate term composition (pk-free core, PK penalties, band-scaled terms, total) without changing default API behavior.",
      "depends_on": [
        10
      ],
      "test_command": "ctest --output-on-failure -R breakdown",
      "retry_limit": 2,
      "done_when": [
        "Debug-only breakdown object contains requested term groups.",
        "Breakdown total matches evaluator total within abs_tol/rel_tol.",
        "Default public API behavior is unchanged.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*breakdown*",
        "tests/*breakdown*"
      ],
      "passes": true
    },
    {
      "id": 13,
      "story": "Run end-to-end fixed-energy validation on tests/cparty_fixed_structure_energy/test.multi.fa and produce a short markdown report with observed energies and any unsupported cases.",
      "depends_on": [
        11,
        12
      ],
      "test_command": "ctest --output-on-failure -R fixed_energy_e2e",
      "retry_limit": 1,
      "done_when": [
        "End-to-end fixture set runs successfully.",
        "Observed energies are recorded with case identifiers.",
        "Unsupported cases are listed with explicit reasons.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/cparty_fixed_structure_energy/test.multi.fa",
        "documents/fixed_energy_report.md"
      ],
      "passes": true
    },
    {
      "id": 14,
      "story": "Phase 2 kickoff: Define a shared can-pair hard-constraint policy layer and add a CLI density2 MFE baseline generator/parser for tests/cparty_fixed_structure_energy/test.multi.fa across flag combinations.",
      "depends_on": [
        13
      ],
      "test_command": "ctest --output-on-failure -R '(can_pair_policy|fixed_energy_cli_baseline)'",
      "retry_limit": 2,
      "done_when": [
        "Single shared can-pair policy helper exists and is documented.",
        "CLI output parser for density2 MFE structure/energy is implemented and tested.",
        "Baseline dataset is generated from tests/cparty_fixed_structure_energy/test.multi.fa with explicit flag metadata.",
        "Existing get_structure_energy behavior remains unchanged for current fixtures.",
        "ctest filters 'can_pair_policy' and 'fixed_energy_cli_baseline' pass.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*can*pair*",
        "tests/*cli*baseline*",
        "tests/baselines/fixed_energy_cli/*",
        "documents/fixed_energy_cli_baseline.md",
        "src/*fixed*energy*",
        "tests/*can_pair_policy*"
      ],
      "passes": true
    },
    {
      "id": 15,
      "story": "Refactor src/pseudo_loop.cc further into testable helper units to isolate can-pair decision points before behavior changes.",
      "depends_on": [
        14
      ],
      "test_command": "ctest --output-on-failure -R pseudo_loop_refactor_phase2",
      "retry_limit": 2,
      "done_when": [
        "Major recurrence branches in pseudo_loop are split into helper functions.",
        "Can-pair branching points are explicit and unit-testable.",
        "ctest filter 'pseudo_loop_refactor_phase2' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/pseudo_loop.cc",
        "src/pseudo_loop.hh",
        "tests/*pseudo_loop_refactor_phase2*"
      ],
      "passes": true
    },
    {
      "id": 16,
      "story": "Refactor src/part_func.cc further into testable helper units to isolate can-pair decision points before behavior changes.",
      "depends_on": [
        14
      ],
      "test_command": "ctest --output-on-failure -R part_func_refactor_phase2",
      "retry_limit": 2,
      "done_when": [
        "Partition-function recurrence branches are split into helper functions.",
        "Can-pair decision points are explicit and unit-testable.",
        "ctest filter 'part_func_refactor_phase2' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/part_func.cc",
        "src/part_func.hh",
        "tests/*part_func_refactor_phase2*"
      ],
      "passes": true
    },
    {
      "id": 17,
      "story": "Apply shared can-pair hard constraints in pseudo_loop energy recurrences with behavior-preserving guards for unsupported cases.",
      "depends_on": [
        15
      ],
      "test_command": "ctest --output-on-failure -R pseudo_loop_can_pair_integration",
      "retry_limit": 2,
      "done_when": [
        "Pseudo-loop recurrence paths use shared can-pair policy at all intended pair checks.",
        "Unsupported/invalid pair formations are blocked consistently.",
        "ctest filter 'pseudo_loop_can_pair_integration' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/pseudo_loop.cc",
        "tests/*pseudo_loop_can_pair_integration*"
      ],
      "passes": true
    },
    {
      "id": 18,
      "story": "Apply shared can-pair hard constraints in part_func partition-function recurrences, matching pseudo_loop policy semantics.",
      "depends_on": [
        16,
        17
      ],
      "test_command": "ctest --output-on-failure -R part_func_can_pair_integration",
      "retry_limit": 2,
      "done_when": [
        "Partition-function recurrence paths use shared can-pair policy at all intended pair checks.",
        "Semantics align with pseudo_loop and fixed-energy API decisions.",
        "ctest filter 'part_func_can_pair_integration' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/part_func.cc",
        "tests/*part_func_can_pair_integration*"
      ],
      "passes": true
    },
    {
      "id": 19,
      "story": "Add cross-path consistency tests to compare can-pair acceptance/rejection outcomes across fixed-energy API, pseudo_loop, and part_func entry points.",
      "depends_on": [
        18
      ],
      "test_command": "ctest --output-on-failure -R can_pair_cross_path_consistency",
      "retry_limit": 2,
      "done_when": [
        "Shared acceptance/rejection matrix is defined for representative PK-free/H-type/K-type and invalid cases.",
        "All targeted paths agree on can-pair hard-constraint outcomes for the matrix.",
        "ctest filter 'can_pair_cross_path_consistency' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/*can_pair_cross_path_consistency*",
        "documents/can_pair_consistency_matrix.md"
      ],
      "passes": true
    },
    {
      "id": 20,
      "story": "Finalize full-algorithm can-pair rollout with regression/performance smoke checks and summary report.",
      "depends_on": [
        19
      ],
      "test_command": "ctest --output-on-failure -R can_pair_rollout_e2e",
      "retry_limit": 1,
      "done_when": [
        "All existing regression tests and new can-pair integration tests pass together.",
        "No critical runtime regression is observed in representative smoke inputs.",
        "Rollout summary report documents changed decision points and any remaining limitations.",
        "Full regression command passes."
      ],
      "artifacts": [
        "documents/can_pair_rollout_report.md"
      ],
      "passes": true
    },
    {
      "id": 21,
      "story": "Add direct numeric alignment checks between CParty CLI density2 MFE energy and get_structure_energy(seq, mfe_structure) using parsed CLI baselines.",
      "depends_on": [
        20
      ],
      "test_command": "ctest --output-on-failure -R api_cli_density2_energy_alignment",
      "retry_limit": 2,
      "done_when": [
        "Test loads tests/baselines/fixed_energy_cli/density2_mfe.tsv and reconstructs (seq, mfe_structure, mfe_energy) cases.",
        "For rows with status=ok, get_structure_energy(seq, mfe_structure) is finite and compared to CLI mfe_energy with abs_tol/rel_tol.",
        "Rows with CLI nonzero exit status are skipped with explicit reason logging.",
        "ctest filter 'api_cli_density2_energy_alignment' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/*api_cli_density2_energy_alignment*",
        "documents/fixed_energy_cli_alignment_report.md"
      ],
      "passes": true
    },
    {
      "id": 22,
      "story": "Investigate and document root causes of CLI density2 MFE vs fixed-structure API energy mismatches, and keep the analysis synchronized with current code changes.",
      "depends_on": [
        21
      ],
      "test_command": "ctest --output-on-failure -R api_cli_density2_energy_alignment",
      "retry_limit": 2,
      "done_when": [
        "Mismatch categories are explicitly documented (option/context mismatch, model-term mismatch, parser/baseline mismatch, or implementation bug).",
        "For each current mismatched fixture/flag row, a concrete cause hypothesis is recorded with code pointer(s).",
        "A prioritized fix order is documented and accepted for the next stages.",
        "The analysis document is updated whenever assumptions change due to new implementation work."
      ],
      "artifacts": [
        "documents/fixed_energy_cli_alignment_report.md",
        "documents/fixed_energy_cli_mismatch_analysis.md"
      ],
      "passes": true
    },
    {
      "id": 23,
      "story": "Introduce shared EnergyEvalOptions/EnergyEvalContext in production code paths and wire CLI fixed-structure evaluation and get_structure_energy through the same option semantics.",
      "depends_on": [
        22
      ],
      "test_command": "ctest --output-on-failure -R \"api_structure_energy_.*|fixed_energy_e2e|api_cli_density2_energy_alignment\"",
      "retry_limit": 2,
      "done_when": [
        "A shared options/context type is introduced and used in production (not test-only) call paths.",
        "CLI runtime flags (-p, -k, -d) are translated into the shared options/context before fixed-structure energy evaluation.",
        "get_structure_energy overload with options uses the same shared options/context contract.",
        "Flags/policy knobs relevant to can-pair and density behavior are represented explicitly in the shared context.",
        "Invoking shared fixed-energy evaluation from CLI does not mutate or invalidate the parameter set used by subsequent CLI MFE/PF computations in the same run.",
        "At least one regression/integration test explicitly guards against CLI parameter-state side effects introduced by shared evaluation wiring.",
        "No behavior regression is introduced for existing fixed-energy API validation and compatibility tests."
      ],
      "artifacts": [
        "src/CPartyAPI.hh",
        "src/CPartyAPI.cc",
        "src/CParty.cc",
        "src/*energy*",
        "tests/*api_structure_energy*",
        "tests/*api_cli_density2_energy_alignment*"
      ],
      "passes": false
    },
    {
      "id": 24,
      "story": "Refactor fixed-structure energy computation into a single shared scorer used by both CLI density2 output and public API, while preserving current semantics.",
      "depends_on": [
        23
      ],
      "test_command": "ctest --output-on-failure -R \"fixed_energy_e2e|api_cli_density2_energy_alignment|can_pair_cross_path_consistency\"",
      "retry_limit": 2,
      "done_when": [
        "Core fixed-structure scoring logic exists in one implementation unit and both call sites delegate to it.",
        "CLI/API no longer duplicate formula branches for shared fixed-structure terms.",
        "Cross-path can-pair acceptance/rejection consistency remains green."
      ],
      "artifacts": [
        "src/*energy*",
        "src/pseudo_loop.cc",
        "src/part_func.cc",
        "tests/*fixed_energy_e2e*",
        "tests/*api_cli_density2_energy_alignment*"
      ],
      "passes": true
    },
    {
      "id": 25,
      "story": "Harden alignment gate: treat any CLI-vs-API energy mismatch on comparable rows as test failure, and keep nonzero-exit CLI rows explicitly skipped.",
      "depends_on": [
        24
      ],
      "test_command": "ctest --output-on-failure -R api_cli_density2_energy_alignment",
      "retry_limit": 2,
      "done_when": [
        "api_cli_density2_energy_alignment fails when mismatched > 0 for comparable rows.",
        "Skipped rows are only those with nonzero CLI exit and each skip reason is recorded.",
        "Report includes compared/skipped/mismatched counts and uses configured abs_tol/rel_tol."
      ],
      "artifacts": [
        "tests/api_cli_density2_energy_alignment_test.cc",
        "documents/fixed_energy_cli_alignment_report.md"
      ],
      "passes": false
    },
    {
      "id": 26,
      "story": "Reduce complexity in src/pseudo_loop.cc and src/part_func.cc with behavior-preserving extraction around can-pair and fixed-energy touchpoints.",
      "depends_on": [
        25
      ],
      "test_command": "ctest --output-on-failure -R \"pseudo_loop_refactor_phase2|part_func_refactor_phase2|can_pair_rollout_e2e|api_cli_density2_energy_alignment\"",
      "retry_limit": 2,
      "done_when": [
        "Long functions in pseudo_loop/part_func are split into smaller helpers with clear names and explicit input contracts.",
        "All existing can-pair rollout and fixed-energy alignment tests remain green after extraction.",
        "No functional delta is introduced other than readability/testability improvements."
      ],
      "artifacts": [
        "src/pseudo_loop.cc",
        "src/part_func.cc",
        "src/pseudo_loop.hh",
        "src/part_func.hh"
      ],
      "passes": false
    },
    {
      "id": 27,
      "story": "Finalize numeric cross-path consistency: CLI density2 MFE and fixed-structure API energies are aligned for all comparable baseline rows under shared options.",
      "depends_on": [
        26
      ],
      "test_command": "ctest --output-on-failure -R \"api_cli_density2_energy_alignment|can_pair_rollout_e2e\"",
      "retry_limit": 2,
      "done_when": [
        "For all comparable rows in tests/baselines/fixed_energy_cli/density2_mfe.tsv, mismatched=0 within abs_tol/rel_tol.",
        "Known non-comparable rows are explicitly documented with deterministic skip reasons.",
        "Full regression command passes."
      ],
      "artifacts": [
        "documents/fixed_energy_cli_alignment_report.md",
        "documents/fixed_energy_cli_mismatch_analysis.md",
        "tests/baselines/fixed_energy_cli/density2_mfe.tsv"
      ],
      "passes": false
    }
  ]
}
