{
  "project_name": "CParty Fixed-Structure Energy",
  "goal": "Refactor CParty safely with regression-first TDD, then add a fixed-structure energy API E(G union G', S) for exact conditional probability workflows.",
  "notes": [
    "This PRD is CParty-only and intentionally excludes parent-repo workflow noise.",
    "Use small, behavior-preserving commits for refactoring steps.",
    "Do not treat CParty CLI -r output as fixed-structure energy ground truth."
  ],
  "execution_policy": {
    "story_selection_policy": {
      "order": "id_ascending",
      "respect_depends_on": true
    },
    "pass_update_policy": {
      "set_passes_true_only_if": [
        "all done_when conditions are satisfied",
        "required artifacts exist or are updated",
        "story test_command passes",
        "full regression command passes"
      ]
    },
    "test_gates": {
      "per_story_required": true,
      "full_regression_after_each_story": true,
      "full_regression_command": "ctest --output-on-failure"
    },
    "default_retry_limit": 2,
    "global_stop_condition": {
      "max_consecutive_identical_failures": 3,
      "max_total_failures": 12,
      "halt_on_signals": [
        "repeated_test_infrastructure_failure",
        "fixture_schema_missing_or_unreadable",
        "build_system_configuration_broken"
      ]
    }
  },
  "numeric_tolerance": {
    "abs_tol": 1e-06,
    "rel_tol": 1e-06
  },
  "user_stories": [
    {
      "id": 1,
      "story": "Add a regression test matrix for existing CParty behavior (with combinations of -p, -k, -d, with/without -r). Focus on non-regression, finite outputs, and deterministic behavior.",
      "depends_on": [],
      "test_command": "ctest --output-on-failure -R regression",
      "retry_limit": 2,
      "done_when": [
        "Regression matrix covers all declared flag combinations.",
        "Determinism and finite-output assertions are present.",
        "ctest filter 'regression' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/*regression*",
        "tests/baselines/*"
      ],
      "passes": true
    },
    {
      "id": 2,
      "story": "Create/normalize fixed-energy fixtures in tests/cparty_fixed_structure_energy/, including PK-free, H-type, K-type, and invalid cases. Ensure every valid case has consistent lengths and parseable structures.",
      "depends_on": [
        1
      ],
      "test_command": "ctest --output-on-failure -R fixtures",
      "retry_limit": 2,
      "done_when": [
        "Fixture schema documented and enforced.",
        "Valid fixtures parse and have matching sequence/structure lengths.",
        "Invalid fixtures are explicitly tagged and tested.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/cparty_fixed_structure_energy/*",
        "tests/cparty_fixed_structure_energy/README*"
      ],
      "passes": true
    },
    {
      "id": 3,
      "story": "Refactor src/pseudo_loop.cc into smaller helper functions (behavior-preserving only). Add tests to prove no numeric regressions on the regression matrix.",
      "depends_on": [
        1
      ],
      "test_command": "ctest --output-on-failure -R pseudo_loop",
      "retry_limit": 2,
      "done_when": [
        "pseudo_loop responsibilities split into helper functions.",
        "Regression matrix remains within abs_tol/rel_tol.",
        "ctest filter 'pseudo_loop' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/pseudo_loop.cc",
        "tests/*pseudo_loop*"
      ],
      "passes": true
    },
    {
      "id": 4,
      "story": "Refactor src/part_func.cc to isolate partition-function path from future fixed-structure path, without changing existing outputs.",
      "depends_on": [
        1
      ],
      "test_command": "ctest --output-on-failure -R part_func",
      "retry_limit": 2,
      "done_when": [
        "Partition-function logic is isolated from fixed-structure hooks.",
        "Existing outputs remain unchanged within abs_tol/rel_tol.",
        "ctest filter 'part_func' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/part_func.cc",
        "tests/*part_func*"
      ],
      "passes": true
    },
    {
      "id": 5,
      "story": "Introduce an internal fixed-structure evaluator that computes E(db_full, seq) in kcal/mol and returns NaN on invalid input. Keep it internal first.",
      "depends_on": [
        2,
        3,
        4
      ],
      "test_command": "ctest --output-on-failure -R fixed_energy_internal",
      "retry_limit": 2,
      "done_when": [
        "Internal evaluator entry point exists and is callable from tests.",
        "Valid cases return finite kcal/mol values.",
        "Invalid inputs return NaN.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*fixed_energy_internal*"
      ],
      "passes": true
    },
    {
      "id": 6,
      "story": "Stage 6a: Expose public API declaration get_structure_energy(seq, db_full) in CPartyAPI (declaration only, no behavior change yet).",
      "depends_on": [
        5
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_decl",
      "retry_limit": 2,
      "done_when": [
        "Public API signature exists in headers.",
        "Build remains source-compatible for existing public APIs.",
        "Full regression command passes."
      ],
      "artifacts": [
        "include/*",
        "tests/*api_structure_energy_decl*"
      ],
      "passes": true
    },
    {
      "id": 7,
      "story": "Stage 6b: Implement API input normalization/validation layer (T->U normalization, length/symbol/structure validation) and enforce NaN contract on invalid input.",
      "depends_on": [
        6
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_validation",
      "retry_limit": 2,
      "done_when": [
        "T->U normalization is implemented at API boundary.",
        "Invalid inputs return quiet NaN and tests use std::isnan.",
        "ctest filter 'api_structure_energy_validation' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*api*",
        "tests/*api_structure_energy_validation*"
      ],
      "passes": true
    },
    {
      "id": 8,
      "story": "Stage 6c-1: Connect API to internal evaluator for PK-free and base can-pair hard constraints.",
      "depends_on": [
        7
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_pkfree",
      "retry_limit": 2,
      "done_when": [
        "API calls internal evaluator for PK-free cases.",
        "Base can-pair hard constraints are enforced.",
        "Valid PK-free fixtures return deterministic finite outputs.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*api_structure_energy_pkfree*"
      ],
      "passes": true
    },
    {
      "id": 9,
      "story": "Stage 6c-2: Extend can-pair hard constraints and evaluator wiring for H-type pseudoknot cases.",
      "depends_on": [
        8
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_h_type",
      "retry_limit": 2,
      "done_when": [
        "H-type cases are evaluated through API->internal path.",
        "Constraint failures are handled predictably as NaN.",
        "ctest filter 'api_structure_energy_h_type' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*api_structure_energy_h_type*"
      ],
      "passes": true
    },
    {
      "id": 10,
      "story": "Stage 6c-3: Extend can-pair hard constraints and evaluator wiring for K-type pseudoknot cases; keep unsupported representability as NaN.",
      "depends_on": [
        9
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_k_type",
      "retry_limit": 2,
      "done_when": [
        "K-type cases are evaluated through API->internal path.",
        "Unsupported representability and invalid structures return NaN.",
        "ctest filter 'api_structure_energy_k_type' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*fixed*energy*",
        "tests/*api_structure_energy_k_type*"
      ],
      "passes": true
    },
    {
      "id": 11,
      "story": "Compatibility and deterministic tests for get_structure_energy: repeated-call equality, finite outputs on valid inputs, and no regressions in existing APIs.",
      "depends_on": [
        10
      ],
      "test_command": "ctest --output-on-failure -R api_structure_energy_compat",
      "retry_limit": 2,
      "done_when": [
        "Repeated identical calls produce equal outputs within abs_tol/rel_tol.",
        "Existing public API behavior remains compatible.",
        "ctest filter 'api_structure_energy_compat' passes.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/*api_structure_energy_compat*"
      ],
      "passes": true
    },
    {
      "id": 12,
      "story": "Add optional internal EnergyBreakdown diagnostics (debug-only) to help validate term composition (pk-free core, PK penalties, band-scaled terms, total) without changing default API behavior.",
      "depends_on": [
        10
      ],
      "test_command": "ctest --output-on-failure -R breakdown",
      "retry_limit": 2,
      "done_when": [
        "Debug-only breakdown object contains requested term groups.",
        "Breakdown total matches evaluator total within abs_tol/rel_tol.",
        "Default public API behavior is unchanged.",
        "Full regression command passes."
      ],
      "artifacts": [
        "src/*breakdown*",
        "tests/*breakdown*"
      ],
      "passes": true
    },
    {
      "id": 13,
      "story": "Run end-to-end fixed-energy validation on tests/cparty_fixed_structure_energy/test.multi.fa and produce a short markdown report with observed energies and any unsupported cases.",
      "depends_on": [
        11,
        12
      ],
      "test_command": "ctest --output-on-failure -R fixed_energy_e2e",
      "retry_limit": 1,
      "done_when": [
        "End-to-end fixture set runs successfully.",
        "Observed energies are recorded with case identifiers.",
        "Unsupported cases are listed with explicit reasons.",
        "Full regression command passes."
      ],
      "artifacts": [
        "tests/cparty_fixed_structure_energy/test.multi.fa",
        "documents/fixed_energy_report.md"
      ],
      "passes": true
    }
  ]
}
