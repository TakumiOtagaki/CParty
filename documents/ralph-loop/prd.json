{
  "project": "CParty SCFG consolidation and fixed-structure energy rollout (density-2 strict)",
  "branchName": "feature/scfg-refactor-fixed-energy",
  "owner": "ootagakitakumi",
  "id_policy": "Stories must be processed in ascending id order.",
  "architecture_goal": {
    "target": "Single SCFG-oriented core where partition/MFE/fixed-energy share rule-level logic.",
    "must_hold": [
      "Rule evaluation logic is centralized behind SCFG class/interfaces.",
      "Constraint oracle (empty-region + pair-type + structure validity) is shared across paths.",
      "Fixed-structure energy path is not an ad-hoc duplicate path."
    ]
  },
  "constraints": {
    "mode": "-d2 only",
    "sequence_alphabet": "A,U,G,C only",
    "reject_T": true,
    "allow_GU": true,
    "numeric_tolerance": {
      "abs_tol": 1e-7,
      "rel_tol": 1e-7
    },
    "mandatory_seed_dataset": "test/multi.secstruct"
  },
  "contracts": {
    "invalid_input_contract": "Deterministic single contract only (one fixed error code or one fixed exception type).",
    "random_generator_role": "Generator only (not parser); unambiguity is not required for generation."
  },
  "runtime_requirements": {
    "shell": "bash",
    "python": "python3"
  },
  "audit_log_policy": {
    "directory": "documents/ralph-loop/audit",
    "file_pattern": "{story_id}.md",
    "required_sections": [
      "Story",
      "Commit",
      "Commands",
      "Metrics",
      "Result",
      "Blockers"
    ],
    "rule": "One log file per story. Reuse the same file if retried."
  },
  "execution_policy": {
    "fresh_build_required": true,
    "fresh_build_command": "rm -rf build && cmake -S . -B build && cmake --build build",
    "strict_regression_after_each_refactor": true,
    "refactor_only_story_ids": [
      "007",
      "008",
      "009",
      "010"
    ],
    "refactor_nonregression_rule": "For refactor_only_story_ids: refactor_compared_current == refactor_compared_previous AND refactor_strict_mismatched_current <= refactor_strict_mismatched_previous.",
    "required_metrics_refactor": [
      "refactor_compared",
      "refactor_strict_mismatched"
    ],
    "required_metrics_alignment": [
      "alignment_compared",
      "alignment_mismatched",
      "skipped",
      "finite_rate"
    ],
    "refactor_extraction_policy": {
      "rule": "Extract repeated concrete operations first, not broad abstract names.",
      "candidate_threshold": "Same or near-identical operation appears >= 3 times.",
      "hot_loop_rule": "Do not force helper extraction for trivial arithmetic in hot loops.",
      "naming_rule": "Prefer specific names like is_empty_region / is_pair_type_allowed / is_transition_allowed instead of overly broad generic labels."
    },
    "forbidden_shortcuts": [
      "Do not set passes=true without command evidence in same iteration.",
      "Do not treat compared=0 as success.",
      "Do not rely on stale build artifacts.",
      "Do not modify baselines only to force green unless the story explicitly says baseline refresh.",
      "Do not claim refactor-only completion if refactor_compared/refactor_strict_mismatched are missing.",
      "Do not claim alignment completion if alignment_compared/alignment_mismatched are missing."
    ]
  },
  "global_stop_condition": {
    "type": "all_stories_pass",
    "strict_requirements": [
      "All userStories.passes == true",
      "Story 014 strict gate satisfied",
      "No unresolved blocker in notes"
    ]
  },
  "retry_limit": {
    "per_story": 2,
    "on_exceed": "Stop loop, append blocker analysis to documents/ralph-loop/progress.txt, keep story passes=false."
  },
  "userStories": [
    {
      "id": "001",
      "title": "Normalize test harness paths and source-controlled ctest registration",
      "priority": 1,
      "depends_on": [],
      "done_when": [
        "CMakeLists.txt registers tests from source tree (not stale build cache only)",
        "Test directory policy is explicit (use test/ as canonical), with no ambiguous references",
        "ctest -N from fresh build lists source-defined tests"
      ],
      "artifacts": [
        "CMakeLists.txt",
        "test/README.md",
        "documents/ralph-loop/audit/001.md"
      ],
      "commands": [
        "rm -rf build && cmake -S . -B build && cmake --build build",
        "ctest --test-dir build -N"
      ],
      "passes": false,
      "notes": "No algorithm change. Build/test plumbing only. Caution: do not confuse stale build-cache tests with source-defined tests; validate using fresh build + ctest -N output."
    },
    {
      "id": "002",
      "title": "Lock mandatory seed dataset from test/multi.secstruct",
      "priority": 2,
      "depends_on": [
        "001"
      ],
      "done_when": [
        "Parser for test/multi.secstruct exists",
        "All entries in test/multi.secstruct are consumed (no skip allowed)",
        "Validation test fails if file row count or ids drift unexpectedly"
      ],
      "artifacts": [
        "test/multi.secstruct",
        "test/fixtures/seed_from_multi_secstruct.tsv",
        "test/multi_secstruct_schema_test.cc",
        "documents/ralph-loop/audit/002.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R multi_secstruct"
      ],
      "passes": false,
      "notes": "User-required mandatory seed set."
    },
    {
      "id": "003",
      "title": "Implement CLI stdout parser for MFE structure and energy",
      "priority": 3,
      "depends_on": [
        "002"
      ],
      "done_when": [
        "Parser extracts sequence/restricted/result lines from CParty stdout",
        "Parser captures density-2 MFE structure and energy deterministically",
        "Parser exits non-zero on malformed stdout"
      ],
      "artifacts": [
        "test/tools/parse_cparty_stdout.sh",
        "test/tools/parse_cparty_stdout_test.sh",
        "documents/ralph-loop/audit/003.md"
      ],
      "commands": [
        "test/tools/parse_cparty_stdout_test.sh"
      ],
      "passes": false,
      "notes": "Parsing framework is separate from random generation."
    },
    {
      "id": "004",
      "title": "Implement random S,G generator (PK-free grammar)",
      "priority": 4,
      "depends_on": [
        "003"
      ],
      "done_when": [
        "Generator implements grammar S -> S '.' | S '(' S ')' | epsilon",
        "Generated G is pseudoknot-free and balanced",
        "Generated base pairs in G satisfy AU/GC/GU constraints",
        "Seed is controllable for reproducibility"
      ],
      "artifacts": [
        "test/tools/gen_random_seq_struct.py",
        "test/tools/gen_random_seq_struct_test.sh",
        "documents/ralph-loop/audit/004.md"
      ],
      "commands": [
        "test/tools/gen_random_seq_struct_test.sh"
      ],
      "passes": false,
      "notes": "Random generation is standalone and reusable."
    },
    {
      "id": "005",
      "title": "Create baseline capture pipeline from mandatory + random cases",
      "priority": 5,
      "depends_on": [
        "004"
      ],
      "done_when": [
        "Pipeline runs CParty with fixed params (-d2 fixed) on all seed and random cases",
        "Pipeline records {case_id, seq, G, cli_mfe_structure, cli_mfe_energy} as TSV",
        "At least 100 valid compared-candidate rows are produced"
      ],
      "artifacts": [
        "test/tools/build_density2_cli_baseline.sh",
        "test/baselines/fixed_energy_cli/density2_mfe.tsv",
        "documents/ralph-loop/audit/005.md"
      ],
      "commands": [
        "test/tools/build_density2_cli_baseline.sh build/CParty test/multi.secstruct test/baselines/fixed_energy_cli/density2_mfe.tsv"
      ],
      "passes": false,
      "notes": "This is the core data expansion step."
    },
    {
      "id": "006",
      "title": "Install anti-cheat alignment gate with explicit strict metrics",
      "priority": 6,
      "depends_on": [
        "005"
      ],
      "done_when": [
        "api_cli_density2_energy_alignment test is source-registered",
        "Test reports alignment_compared/alignment_mismatched/skipped/finite_rate",
        "Test fails when alignment_compared=0",
        "Strict threshold for this phase: alignment_mismatched must be reported exactly (no silent pass)"
      ],
      "artifacts": [
        "test/api_cli_density2_energy_alignment_test.cc",
        "documents/fixed_energy_cli_alignment_report.md",
        "CMakeLists.txt",
        "documents/ralph-loop/audit/006.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R api_cli_density2_energy_alignment"
      ],
      "passes": false,
      "notes": "Gate correctness first, then algorithm convergence."
    },
    {
      "id": "007",
      "title": "Introduce SCFG core interfaces and adapter layer",
      "priority": 7,
      "depends_on": [
        "006"
      ],
      "done_when": [
        "SCFG core class/interfaces exist (rule eval + state access)",
        "Legacy code path compiles through adapter without formula change",
        "Regression output remains identical within tolerance",
        "refactor_compared/refactor_strict_mismatched are reported and satisfy refactor_nonregression_rule"
      ],
      "artifacts": [
        "src/scfg/core.hh",
        "src/scfg/core.cc",
        "src/scfg/legacy_adapter.hh",
        "src/scfg/legacy_adapter.cc",
        "documents/ralph-loop/audit/007.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R api_cli_density2_energy_alignment",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "SCFG集約の最初の実体。"
    },
    {
      "id": "008",
      "title": "Extract shared constraint operations (empty-region/pair-type/validity)",
      "priority": 8,
      "depends_on": [
        "007"
      ],
      "done_when": [
        "Repeated concrete checks (>=3 occurrences) are identified and extracted first",
        "Shared helpers cover empty-region checks and pair-type admissibility where duplicated",
        "At least one part_func and one pseudo_loop path call the shared helpers",
        "Refactor step passes full regression with strict drift checks",
        "refactor_compared/refactor_strict_mismatched satisfy refactor_nonregression_rule"
      ],
      "artifacts": [
        "src/scfg/constraint_oracle.hh",
        "src/scfg/constraint_oracle.cc",
        "test/can_pair_policy_test.cc",
        "documents/ralph-loop/audit/008.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R can_pair_policy",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "Do not over-abstract to a single broad helper label; extract concrete duplicated checks first. (Legacy test target name may still include can_pair.)"
    },
    {
      "id": "009",
      "title": "Refactor pseudo_loop recurrences into SCFG rule helpers",
      "priority": 9,
      "depends_on": [
        "008"
      ],
      "done_when": [
        "pseudo_loop rules are factored into named SCFG helper units",
        "SCFG method groups are implemented incrementally in this order: 1) rule access, 2) transition scoring, 3) constraint checks, 4) DP execution control, 5) traceback/fixed-parse hooks, 6) mode/parameter wiring",
        "Helper boundaries follow refactor_extraction_policy (>=3 duplicated concrete operations first)",
        "No recurrence formula modification in this story",
        "Full regression and alignment gate executed and reported",
        "refactor_compared/refactor_strict_mismatched satisfy refactor_nonregression_rule"
      ],
      "micro_steps": [
        "9.1 Add rule access stubs and route one pseudo_loop path through them",
        "9.2 Add transition scoring helper for one recurrence family",
        "9.3 Add constraint checks (empty-region/pair-type) for the same family",
        "9.4 Add DP execution control helper (fill-order compatible)",
        "9.5 Add traceback/fixed-parse hooks without changing recurrence math",
        "9.6 Add mode/parameter wiring used by that path"
      ],
      "artifacts": [
        "src/pseudo_loop.cc",
        "src/scfg/rules_pseudo_loop.hh",
        "src/scfg/rules_pseudo_loop.cc",
        "documents/ralph-loop/audit/009.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R pseudo_loop",
        "ctest --test-dir build --output-on-failure -R api_cli_density2_energy_alignment",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "Strictly behavior-preserving refactor. Prioritize concrete repeated operations over broad abstraction."
    },
    {
      "id": "010",
      "title": "Refactor part_func recurrences into SCFG rule helpers",
      "priority": 10,
      "depends_on": [
        "009"
      ],
      "done_when": [
        "part_func rules are factored into named SCFG helper units",
        "SCFG method groups are implemented incrementally in this order: 1) rule access, 2) transition scoring, 3) constraint checks, 4) DP execution control, 5) traceback/fixed-parse hooks, 6) mode/parameter wiring",
        "Helper boundaries follow refactor_extraction_policy (>=3 duplicated concrete operations first)",
        "No recurrence formula modification in this story",
        "Full regression and alignment gate executed and reported",
        "refactor_compared/refactor_strict_mismatched satisfy refactor_nonregression_rule"
      ],
      "micro_steps": [
        "10.1 Port rule access pattern from story 009 to part_func paths",
        "10.2 Port transition scoring helpers to matching recurrence families",
        "10.3 Port constraint checks with identical semantics",
        "10.4 Port DP execution control helpers preserving fill dependencies",
        "10.5 Port traceback/fixed-parse hooks to part_func-facing routes",
        "10.6 Port mode/parameter wiring and validate no drift"
      ],
      "artifacts": [
        "src/part_func.cc",
        "src/scfg/rules_part_func.hh",
        "src/scfg/rules_part_func.cc",
        "documents/ralph-loop/audit/010.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R part_func",
        "ctest --test-dir build --output-on-failure -R api_cli_density2_energy_alignment",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "Strictly behavior-preserving refactor. Prioritize concrete repeated operations over broad abstraction."
    },
    {
      "id": "011",
      "title": "Add get_structure_energy API and strict input contract",
      "priority": 11,
      "depends_on": [
        "010"
      ],
      "done_when": [
        "get_structure_energy(seq, db_full) is callable",
        "AUGC-only contract enforced for API path (T rejected)",
        "Invalid input behavior is deterministic and test-covered"
      ],
      "artifacts": [
        "src/fixed_energy_api.hh",
        "src/fixed_energy_api.cc",
        "test/api_structure_energy_validation_test.cc",
        "documents/ralph-loop/audit/011.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R api_structure_energy",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "API contract phase; may still mismatch CLI energies."
    },
    {
      "id": "012",
      "title": "Connect API evaluator to SCFG core rule path",
      "priority": 12,
      "depends_on": [
        "011"
      ],
      "done_when": [
        "API evaluation uses SCFG core/rule path (not duplicate ad-hoc path)",
        "SCFG parser interfaces (rules_for/applicable_rules/rule_score/expand) exist and are exercised by fixed-structure path",
        "Structure parsing path is deterministic for valid input (same input -> same rule chain)",
        "Parser rejects invalid structures via invalid_input_contract",
        "EnergyBreakdown fields are populated consistently",
        "Internal tests cover pk_free/h_type/k_type smoke cases"
      ],
      "micro_steps": [
        "12.1 Add parser entry: db_full -> normalized internal representation",
        "12.2 Implement rules_for(state) and connect one ZW path",
        "12.3 Implement applicable_rules(...) using empty-region/pair-type/transition checks",
        "12.4 Implement rule_score(...) and aggregate minimal EnergyBreakdown on chosen rule chain",
        "12.5 Implement expand(...) with deterministic child ordering and enforce invalid_input_contract when rule is non-unique",
        "12.6 Validate same parser/evaluator path on pk_free/h_type/k_type and run full regression/alignment gate"
      ],
      "artifacts": [
        "src/fixed_energy_breakdown.hh",
        "test/fixed_energy_internal_test.cc",
        "test/fixed_energy_breakdown_test.cc",
        "documents/scfg_fixed_structure_parsing_pseudocode.md",
        "documents/ralph-loop/audit/012.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R fixed_energy_internal",
        "ctest --test-dir build --output-on-failure -R breakdown",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "This is the main functional convergence step. Implement mechanical parsing via rules_for/applicable_rules/rule_score/expand as documented in documents/scfg_fixed_structure_parsing_pseudocode.md."
    },
    {
      "id": "013",
      "title": "Reach strict CLI alignment target (X=0)",
      "priority": 13,
      "depends_on": [
        "012"
      ],
      "done_when": [
        "Alignment gate on valid density-2 dataset reports alignment_compared >= 100",
        "alignment_mismatched = 0",
        "finite_rate = 100%",
        "Report includes absolute and relative diff summary"
      ],
      "artifacts": [
        "test/api_cli_density2_energy_alignment_test.cc",
        "test/baselines/fixed_energy_cli/density2_mfe.tsv",
        "documents/fixed_energy_cli_alignment_report.md",
        "documents/ralph-loop/audit/013.md"
      ],
      "commands": [
        "ctest --test-dir build --output-on-failure -R api_cli_density2_energy_alignment",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "Strict completion gate for numerical agreement."
    },
    {
      "id": "014",
      "title": "Final rollout gate and document truth sync",
      "priority": 14,
      "depends_on": [
        "013"
      ],
      "done_when": [
        "All ctest passes on fresh build",
        "documents/rd.md and documents/ralph-loop/progress.txt reflect actual current code state",
        "Final report logs command transcript and alignment_compared/alignment_mismatched/skipped/finite_rate plus refactor_strict_mismatched"
      ],
      "artifacts": [
        "documents/rd.md",
        "documents/ralph-loop/progress.txt",
        "documents/constraint_rollout_report.md",
        "documents/ralph-loop/audit/014.md"
      ],
      "commands": [
        "rm -rf build && cmake -S . -B build && cmake --build build",
        "ctest --test-dir build --output-on-failure"
      ],
      "passes": false,
      "notes": "Only this story can flip project to COMPLETE."
    }
  ]
}
