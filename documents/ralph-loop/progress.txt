# Ralph Progress Log
Started: 2026-02-13

## Codebase Patterns
- (Add reusable patterns discovered during implementation.)

## 2026-02-13 - 001
- What was implemented: Added source-controlled CTest registration in `CMakeLists.txt` and documented canonical test directory policy in `test/README.md`.
- Files changed: `CMakeLists.txt`, `test/README.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/001.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Fresh-build proof can be made explicit by checking newly generated `build/CTestTestfile.cmake` timestamp before running `ctest`.
  - Even plumbing stories benefit from source-tree smoke tests to prevent stale-build false confidence.
---

## 2026-02-13 - 002
- What was implemented: Added `test/multi.secstruct` parser/schema validation test and locked expected rows via fixture TSV to detect row-count/id/content drift with no skipped entries.
- Files changed: `CMakeLists.txt`, `test/multi_secstruct_schema_test.cc`, `test/fixtures/seed_from_multi_secstruct.tsv`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/002.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Parsing the dataset as header/sequence/structure records with blank-line tolerance keeps ingestion strict while remaining stable to spacing changes.
  - A fixture-driven equality check (including duplicate IDs and ordering) is an effective guard against silent seed-dataset drift.
---

## 2026-02-13 - 003
- What was implemented: Added `test/tools/parse_cparty_stdout.sh` to parse CParty stdout into deterministic TSV fields (`seq`, `restricted`, `cli_mfe_structure`, `cli_mfe_energy`) and fail non-zero on malformed output; added `test/tools/parse_cparty_stdout_test.sh` with valid/malformed fixtures plus live CParty integration check.
- Files changed: `test/tools/parse_cparty_stdout.sh`, `test/tools/parse_cparty_stdout_test.sh`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/003.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - CParty constrained output is stable for parsing: line1 sequence, line2 restricted structure, line3 first structure-energy pair as deterministic density-2 MFE extraction target.
  - For shell parsers, character-filter validation (`tr -d`) is more robust than dense bracket-regex escaping for dot-bracket variants.
---

## 2026-02-13 - 004
- What was implemented: Added `test/tools/gen_random_seq_struct.py` to generate deterministic seedable random `(seq, G)` rows using grammar `S -> S '.' | S '(' S ')' | epsilon`, with pair-aware sequence assignment restricted to AU/GC/GU; added `test/tools/gen_random_seq_struct_test.sh` covering determinism, alphabet constraints, balanced PK-free structures, and allowed base-pair validation.
- Files changed: `test/tools/gen_random_seq_struct.py`, `test/tools/gen_random_seq_struct_test.sh`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/004.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Building structures via bounded recursive expansion of the target grammar keeps outputs naturally pseudoknot-free without post-fix normalization.
  - Assigning paired nucleotides from an explicit allowed-pair set is simpler and more robust than trying to repair invalid pairs after random sequence generation.
---

## 2026-02-13 - 005
- What was implemented: Added `test/tools/build_density2_cli_baseline.sh` to capture CLI baseline TSV from mandatory `test/multi.secstruct` records plus deterministic random cases, and generated `test/baselines/fixed_energy_cli/density2_mfe.tsv` with 152 compared rows (`>=100`).
- Files changed: `test/tools/build_density2_cli_baseline.sh`, `test/baselines/fixed_energy_cli/density2_mfe.tsv`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/005.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Grammar-random structures can trigger frequent CLI crashes in this codebase; using random sequence assignment over known valid `pk_free` seed structures provides stable, reproducible coverage for baseline expansion.
  - Baseline capture should explicitly enforce `compared >= 100` in-script so data sufficiency is guaranteed before downstream alignment gates run.
---

## 2026-02-13 - 006
- What was implemented: Added source-registered alignment gate test `api_cli_density2_energy_alignment` that replays baseline rows through `CParty -d2 -r`, compares structure/energy with tolerances, prints `alignment_compared/alignment_mismatched/skipped/finite_rate`, and fails when `alignment_compared=0`.
- Files changed: `CMakeLists.txt`, `test/api_cli_density2_energy_alignment_test.cc`, `documents/fixed_energy_cli_alignment_report.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/006.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Registering the gate as a compiled CTest target keeps anti-cheat checks source-controlled and reproducible in fresh-build runs.
  - Early-phase alignment gate value comes from reliable metric emission and zero-compare fail-fast, even before convergence to `alignment_mismatched=0`.
---

## 2026-02-13 - 007
- What was implemented: Added initial SCFG core interface (`Core`) and a `LegacyAdapter` layer, then routed repeated legacy pair-span checks in `part_func` and `pseudo_loop` through the adapter to preserve formulas while compiling through the new SCFG path. Also updated the alignment gate output to emit `refactor_compared` and `refactor_strict_mismatched` alongside alignment metrics.
- Files changed: `CMakeLists.txt`, `src/scfg/core.hh`, `src/scfg/core.cc`, `src/scfg/legacy_adapter.hh`, `src/scfg/legacy_adapter.cc`, `src/part_func.cc`, `src/pseudo_loop.cc`, `test/api_cli_density2_energy_alignment_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/007.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - A thin adapter that mirrors existing `tree.up` span predicates is a low-risk way to introduce SCFG interfaces before deeper recurrence extraction.
  - Emitting `refactor_*` and `alignment_*` metrics from the same source-controlled gate simplifies refactor-story evidence while keeping metric semantics explicit.
---

## 2026-02-13 - 008
- What was implemented: Added shared SCFG constraint helpers in `constraint_oracle` (`is_empty_region`, `is_unpaired_position`, `is_pair_type_allowed`), then replaced repeated concrete checks in both `part_func` and `pseudo_loop` VP/BE paths; added source-registered `can_pair_policy` test for helper behavior.
- Files changed: `CMakeLists.txt`, `src/scfg/constraint_oracle.hh`, `src/scfg/constraint_oracle.cc`, `src/part_func.cc`, `src/pseudo_loop.cc`, `test/can_pair_policy_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/008.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Open-interval emptiness (`left,right`) is a reusable primitive that directly replaces multiple duplicated `tree.up[...]` predicates without changing recurrence math.
  - Extracting pair-type admissibility (`ptype > 0`) as a dedicated helper keeps constraints explicit and avoids broad, abstraction-first wrappers.
---

## 2026-02-13 - 009
- What was implemented: Added SCFG pseudo-loop helper module (`rules_pseudo_loop`) and refactored `pseudo_loop::compute_WMBP` case-1/2 recurrence paths to use named helper units for rule access, transition scoring, constraint checks, DP split iteration, and mode wiring, with no recurrence formula changes.
- Files changed: `CMakeLists.txt`, `src/pseudo_loop.cc`, `src/scfg/rules_pseudo_loop.hh`, `src/scfg/rules_pseudo_loop.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/009.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - In this codebase, border accessors on `sparse_tree` are non-const; SCFG helper layers that centralize border logic must accept mutable tree references even for read-like access.
  - Repeated WMBP split predicates (exterior-case + band-border + parent/turn checks) are a concrete extraction target that improves recurrence readability without altering math.
---

## 2026-02-13 - 010
- What was implemented: Added SCFG part-function helper module (`rules_part_func`) and refactored `W_final_pf::compute_WMBP` case-1/2/4 recurrence paths to use named helper units for rule access, transition scoring, constraint checks, DP split iteration, hook stubs, and mode wiring while preserving recurrence formulas.
- Files changed: `CMakeLists.txt`, `src/part_func.cc`, `src/scfg/rules_part_func.hh`, `src/scfg/rules_part_func.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/010.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Reusing the same helper shape across `pseudo_loop` and `part_func` keeps SCFG migration incremental and reduces risk of formula drift in large recurrence blocks.
  - Keeping contribution accumulation order unchanged (while only extracting gating/penalty operations) is an effective strategy for behavior-preserving refactors in partition-function code.
---

## 2026-02-13 - 011
- What was implemented: Added new fixed-structure API entrypoint `get_structure_energy(seq, db_full)` with strict deterministic input validation (A/U/G/C only, explicit T rejection, length + balanced dot-bracket checks) and a source-registered validation test.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/api_structure_energy_validation_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/011.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Enforcing a single exception type at the API boundary (`std::invalid_argument`) keeps invalid-input behavior deterministic while still allowing specific diagnostics.
  - Isolating strict input normalization/validation in story 011 keeps parser/rule-chain integration work for later stories focused on scoring logic instead of contract handling.
---

## 2026-02-13 - 012
- What was implemented: Replaced the fixed-structure placeholder scorer with a deterministic mechanical SCFG parser flow (`rules_for`/`applicable_rules`/`rule_score`/`expand`) and wired the API path to execute the parser-selected rule chain; added `fixed_energy_internal` ctest target for deterministic trace and contract checks.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/fixed_energy_internal_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/012.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - A single-state interval parser (`ZW`) with deterministic child push order is enough to enforce deterministic fixed-structure rule-chain traversal without introducing recurrence drift.
  - Keeping invalid-input failures unified through the existing `std::invalid_argument` contract lets parser-stage rule-selection failures and upfront format validation share one deterministic API contract.
---
