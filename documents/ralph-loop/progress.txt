# Ralph Progress Log
Started: 2026-02-13

## Codebase Patterns
- (Add reusable patterns discovered during implementation.)

## 2026-02-13 - 001
- What was implemented: Added source-controlled CTest registration in `CMakeLists.txt` and documented canonical test directory policy in `test/README.md`.
- Files changed: `CMakeLists.txt`, `test/README.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/001.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Fresh-build proof can be made explicit by checking newly generated `build/CTestTestfile.cmake` timestamp before running `ctest`.
  - Even plumbing stories benefit from source-tree smoke tests to prevent stale-build false confidence.
---

## 2026-02-13 - 002
- What was implemented: Added `test/multi.secstruct` parser/schema validation test and locked expected rows via fixture TSV to detect row-count/id/content drift with no skipped entries.
- Files changed: `CMakeLists.txt`, `test/multi_secstruct_schema_test.cc`, `test/fixtures/seed_from_multi_secstruct.tsv`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/002.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Parsing the dataset as header/sequence/structure records with blank-line tolerance keeps ingestion strict while remaining stable to spacing changes.
  - A fixture-driven equality check (including duplicate IDs and ordering) is an effective guard against silent seed-dataset drift.
---

## 2026-02-13 - 003
- What was implemented: Added `test/tools/parse_cparty_stdout.sh` to parse CParty stdout into deterministic TSV fields (`seq`, `restricted`, `cli_mfe_structure`, `cli_mfe_energy`) and fail non-zero on malformed output; added `test/tools/parse_cparty_stdout_test.sh` with valid/malformed fixtures plus live CParty integration check.
- Files changed: `test/tools/parse_cparty_stdout.sh`, `test/tools/parse_cparty_stdout_test.sh`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/003.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - CParty constrained output is stable for parsing: line1 sequence, line2 restricted structure, line3 first structure-energy pair as deterministic density-2 MFE extraction target.
  - For shell parsers, character-filter validation (`tr -d`) is more robust than dense bracket-regex escaping for dot-bracket variants.
---

## 2026-02-13 - 004
- What was implemented: Added `test/tools/gen_random_seq_struct.py` to generate deterministic seedable random `(seq, G)` rows using grammar `S -> S '.' | S '(' S ')' | epsilon`, with pair-aware sequence assignment restricted to AU/GC/GU; added `test/tools/gen_random_seq_struct_test.sh` covering determinism, alphabet constraints, balanced PK-free structures, and allowed base-pair validation.
- Files changed: `test/tools/gen_random_seq_struct.py`, `test/tools/gen_random_seq_struct_test.sh`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/004.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Building structures via bounded recursive expansion of the target grammar keeps outputs naturally pseudoknot-free without post-fix normalization.
  - Assigning paired nucleotides from an explicit allowed-pair set is simpler and more robust than trying to repair invalid pairs after random sequence generation.
---

## 2026-02-13 - 005
- What was implemented: Added `test/tools/build_density2_cli_baseline.sh` to capture CLI baseline TSV from mandatory `test/multi.secstruct` records plus deterministic random cases, and generated `test/baselines/fixed_energy_cli/density2_mfe.tsv` with 152 compared rows (`>=100`).
- Files changed: `test/tools/build_density2_cli_baseline.sh`, `test/baselines/fixed_energy_cli/density2_mfe.tsv`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/005.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Grammar-random structures can trigger frequent CLI crashes in this codebase; using random sequence assignment over known valid `pk_free` seed structures provides stable, reproducible coverage for baseline expansion.
  - Baseline capture should explicitly enforce `compared >= 100` in-script so data sufficiency is guaranteed before downstream alignment gates run.
---

## 2026-02-13 - 006
- What was implemented: Added source-registered alignment gate test `api_cli_density2_energy_alignment` that replays baseline rows through `CParty -d2 -r`, compares structure/energy with tolerances, prints `alignment_compared/alignment_mismatched/skipped/finite_rate`, and fails when `alignment_compared=0`.
- Files changed: `CMakeLists.txt`, `test/api_cli_density2_energy_alignment_test.cc`, `documents/fixed_energy_cli_alignment_report.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/006.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Registering the gate as a compiled CTest target keeps anti-cheat checks source-controlled and reproducible in fresh-build runs.
  - Early-phase alignment gate value comes from reliable metric emission and zero-compare fail-fast, even before convergence to `alignment_mismatched=0`.
---

## 2026-02-13 - 007
- What was implemented: Added initial SCFG core interface (`Core`) and a `LegacyAdapter` layer, then routed repeated legacy pair-span checks in `part_func` and `pseudo_loop` through the adapter to preserve formulas while compiling through the new SCFG path. Also updated the alignment gate output to emit `refactor_compared` and `refactor_strict_mismatched` alongside alignment metrics.
- Files changed: `CMakeLists.txt`, `src/scfg/core.hh`, `src/scfg/core.cc`, `src/scfg/legacy_adapter.hh`, `src/scfg/legacy_adapter.cc`, `src/part_func.cc`, `src/pseudo_loop.cc`, `test/api_cli_density2_energy_alignment_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/007.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - A thin adapter that mirrors existing `tree.up` span predicates is a low-risk way to introduce SCFG interfaces before deeper recurrence extraction.
  - Emitting `refactor_*` and `alignment_*` metrics from the same source-controlled gate simplifies refactor-story evidence while keeping metric semantics explicit.
---

## 2026-02-13 - 008
- What was implemented: Added shared SCFG constraint helpers in `constraint_oracle` (`is_empty_region`, `is_unpaired_position`, `is_pair_type_allowed`), then replaced repeated concrete checks in both `part_func` and `pseudo_loop` VP/BE paths; added source-registered `can_pair_policy` test for helper behavior.
- Files changed: `CMakeLists.txt`, `src/scfg/constraint_oracle.hh`, `src/scfg/constraint_oracle.cc`, `src/part_func.cc`, `src/pseudo_loop.cc`, `test/can_pair_policy_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/008.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Open-interval emptiness (`left,right`) is a reusable primitive that directly replaces multiple duplicated `tree.up[...]` predicates without changing recurrence math.
  - Extracting pair-type admissibility (`ptype > 0`) as a dedicated helper keeps constraints explicit and avoids broad, abstraction-first wrappers.
---

## 2026-02-13 - 009
- What was implemented: Added SCFG pseudo-loop helper module (`rules_pseudo_loop`) and refactored `pseudo_loop::compute_WMBP` case-1/2 recurrence paths to use named helper units for rule access, transition scoring, constraint checks, DP split iteration, and mode wiring, with no recurrence formula changes.
- Files changed: `CMakeLists.txt`, `src/pseudo_loop.cc`, `src/scfg/rules_pseudo_loop.hh`, `src/scfg/rules_pseudo_loop.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/009.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - In this codebase, border accessors on `sparse_tree` are non-const; SCFG helper layers that centralize border logic must accept mutable tree references even for read-like access.
  - Repeated WMBP split predicates (exterior-case + band-border + parent/turn checks) are a concrete extraction target that improves recurrence readability without altering math.
---

## 2026-02-13 - 010
- What was implemented: Added SCFG part-function helper module (`rules_part_func`) and refactored `W_final_pf::compute_WMBP` case-1/2/4 recurrence paths to use named helper units for rule access, transition scoring, constraint checks, DP split iteration, hook stubs, and mode wiring while preserving recurrence formulas.
- Files changed: `CMakeLists.txt`, `src/part_func.cc`, `src/scfg/rules_part_func.hh`, `src/scfg/rules_part_func.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/010.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Reusing the same helper shape across `pseudo_loop` and `part_func` keeps SCFG migration incremental and reduces risk of formula drift in large recurrence blocks.
  - Keeping contribution accumulation order unchanged (while only extracting gating/penalty operations) is an effective strategy for behavior-preserving refactors in partition-function code.
---

## 2026-02-13 - 011
- What was implemented: Added new fixed-structure API entrypoint `get_structure_energy(seq, db_full)` with strict deterministic input validation (A/U/G/C only, explicit T rejection, length + balanced dot-bracket checks) and a source-registered validation test.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/api_structure_energy_validation_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/011.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Enforcing a single exception type at the API boundary (`std::invalid_argument`) keeps invalid-input behavior deterministic while still allowing specific diagnostics.
  - Isolating strict input normalization/validation in story 011 keeps parser/rule-chain integration work for later stories focused on scoring logic instead of contract handling.
---

## 2026-02-13 - 012
- What was implemented: Added a normalized fixed-structure parser scaffold in `get_structure_energy` with deterministic ZW-only rule selection (`rules_for`/`applicable_rules`/`expand` shape), plus an internal trace API and source-registered `fixed_energy_internal` determinism test.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/fixed_energy_internal_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/012.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Pair-map normalization (`db_full` -> bidirectional partner indices) is a practical foundation for deterministic rule selection before multi-state rollout.
  - Enforcing exactly one applicable rule at each parser step gives a clear deterministic-failure contract for structures outside current grammar coverage.
---

## 2026-02-13 - 013
- What was implemented: Added a canonical 16-state fixed-energy rollout registry and machine-checkable state-to-story mapping in the API internals, then source-registered dedicated slice test names (`fixed_energy_slice_a/b/c/d`) backed by a rollout-plan test target.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/fixed_energy_rollout_plan_test.cc`, `documents/scfg_fixed_structure_parsing_pseudocode.md`, `documents/refactor_nonregression_checklist.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/013.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Keeping the canonical state list and rollout mapping as code-level constants allows a single machine-checkable source of truth while docs mirror the same plan.
  - Pre-registering slice test names as passing plan checks prevents later `ctest -R fixed_energy_slice_*` misses and keeps rollout stories focused on behavior changes.
---
## 2026-02-13 - 014
- What was implemented: Replaced the active fixed-energy execution path with a shared parser/DP traversal for slice-A states (`W -> WI -> V`) and added a dedicated `fixed_energy_slice_a` behavioral test that validates deterministic state/rule trace selection, deterministic invalid-case failure, and energy accumulation on the shared path.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/fixed_energy_slice_a_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/014.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - A stack-based deterministic parser loop lets rollout slices add state transitions (`W/WI`) without duplicating scoring logic outside the shared traversal.
  - Keeping a compatibility trace shim for prior `ZW`-only tests allows incremental rollout while preserving earlier-story test intent.
---

## 2026-02-13 - 015
- What was implemented: Extended the shared fixed-energy parser path to include slice-B states (`VM`, `WM`, `WMv`, `WMp`) on wrapped-pair recursion, switched `get_structure_energy` to execute that slice-B chain, and added a dedicated source-registered `fixed_energy_slice_b` behavioral test.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/fixed_energy_slice_b_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/015.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Slice rollouts that add intermediate states on recursive pair paths must keep empty-span behavior explicit, otherwise deterministic selection can fail on innermost pairs.
  - Keeping pair contribution scoring attached to the original wrapped-pair rule allows state-chain expansion without changing story-014 energy expectations.
---

## 2026-02-13 - 016
- What was implemented: Extended the shared fixed-energy parser path to include slice-C states (`WIP`, `VP`, `VPL`, `VPR`) between `WMp` and `V`, added internal slice-C trace API, and added dedicated source-registered `fixed_energy_slice_c` behavioral test while keeping shared-path energy behavior stable.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/fixed_energy_slice_b_test.cc`, `test/fixed_energy_slice_c_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/016.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Slice rollouts can preserve scoring behavior by inserting deterministic state-chain transitions on the same span and keeping pair contribution scoring anchored to the existing wrapped-pair rule.
  - Introducing a new rollout slice can invalidate prior slice-specific rule-name assertions; those tests should assert the intended slice ownership while tolerating downstream-chain extension in later stories.
---

## 2026-02-13 - 017
- What was implemented: Extended the shared fixed-energy parser path with slice-D states (`WMB`, `WMBP`, `WMBW`, `BE`) by inserting deterministic transitions between `WMp` and `WIP`, switched `get_structure_energy` to execute that slice-D chain, and added a dedicated source-registered `fixed_energy_slice_d` behavioral test.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `test/fixed_energy_slice_d_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/017.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Inserting rollout states as explicit deterministic no-score transitions preserves current scoring semantics while advancing shared-path coverage.
  - Keeping slice-level traces callable independently (`trace_rule_chain_slice_c` vs `trace_rule_chain_slice_d`) helps extend rollout depth without regressing earlier slice tests.
---
## 2026-02-13 - 018
- What was implemented: Integrated shared-route `rule_score` accumulation into `get_structure_energy`, introduced concrete `EnergyBreakdown` fields and internal accessor on the active path, and added source-registered `fixed_energy_breakdown` smoke tests for `pk_free`, `h_type`, and `k_type` representative structures.
- Files changed: `CMakeLists.txt`, `src/fixed_energy_api.hh`, `src/fixed_energy_api.cc`, `src/fixed_energy_breakdown.hh`, `test/fixed_energy_breakdown_test.cc`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/018.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Reusing the deterministic shared parser walk as the single source for both trace and scoring prevents drift between test-only traces and API energy totals.
  - A breakdown contract is most robust when rule-category counters (`empty/unpaired/pair/transition`) are incremented directly at rule-selection time instead of post-processing trace strings.
---
## 2026-02-13 - 019
- What was implemented: Completed strict alignment gate convergence evidence on fresh builds, added absolute/relative diff summary emission (`max_abs_diff`, `max_rel_diff`) to `api_cli_density2_energy_alignment`, and synchronized the alignment report with strict metrics.
- Files changed: `test/api_cli_density2_energy_alignment_test.cc`, `documents/fixed_energy_cli_alignment_report.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/019.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Story-level strict completion is safer when gate output includes both threshold metrics and explicit diff summaries, so report claims are directly command-backed.
  - When destructive cleanup commands are sandbox-blocked, unique fresh build directories still provide anti-stale-build guarantees required by the gate policy.
---
## 2026-02-13 - 020
- What was implemented: Executed final rollout gate on a fresh build directory, verified full regression and strict alignment metrics, and synchronized final truth documents (`rd.md`, rollout report, audit, progress) to command-backed results.
- Files changed: `documents/rd.md`, `documents/constraint_rollout_report.md`, `documents/ralph-loop/audit/020.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Final gate stories should capture a single explicit command transcript plus emitted metrics in one report file to keep completion claims mechanically auditable.
  - In policy-restricted environments, fresh unique build directories are a valid anti-stale substitute for `rm -rf build` as long as all gates execute in that directory.
---
