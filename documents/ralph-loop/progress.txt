# Ralph Progress Log
Started: 2026-02-13

## Codebase Patterns
- (Add reusable patterns discovered during implementation.)

## 2026-02-13 - 001
- What was implemented: Added source-controlled CTest registration in `CMakeLists.txt` and documented canonical test directory policy in `test/README.md`.
- Files changed: `CMakeLists.txt`, `test/README.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/001.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Fresh-build proof can be made explicit by checking newly generated `build/CTestTestfile.cmake` timestamp before running `ctest`.
  - Even plumbing stories benefit from source-tree smoke tests to prevent stale-build false confidence.
---

## 2026-02-13 - 002
- What was implemented: Added `test/multi.secstruct` parser/schema validation test and locked expected rows via fixture TSV to detect row-count/id/content drift with no skipped entries.
- Files changed: `CMakeLists.txt`, `test/multi_secstruct_schema_test.cc`, `test/fixtures/seed_from_multi_secstruct.tsv`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/002.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Parsing the dataset as header/sequence/structure records with blank-line tolerance keeps ingestion strict while remaining stable to spacing changes.
  - A fixture-driven equality check (including duplicate IDs and ordering) is an effective guard against silent seed-dataset drift.
---

## 2026-02-13 - 003
- What was implemented: Added `test/tools/parse_cparty_stdout.sh` to parse CParty stdout into deterministic TSV fields (`seq`, `restricted`, `cli_mfe_structure`, `cli_mfe_energy`) and fail non-zero on malformed output; added `test/tools/parse_cparty_stdout_test.sh` with valid/malformed fixtures plus live CParty integration check.
- Files changed: `test/tools/parse_cparty_stdout.sh`, `test/tools/parse_cparty_stdout_test.sh`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/003.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - CParty constrained output is stable for parsing: line1 sequence, line2 restricted structure, line3 first structure-energy pair as deterministic density-2 MFE extraction target.
  - For shell parsers, character-filter validation (`tr -d`) is more robust than dense bracket-regex escaping for dot-bracket variants.
---

## 2026-02-13 - 004
- What was implemented: Added `test/tools/gen_random_seq_struct.py` to generate deterministic seedable random `(seq, G)` rows using grammar `S -> S '.' | S '(' S ')' | epsilon`, with pair-aware sequence assignment restricted to AU/GC/GU; added `test/tools/gen_random_seq_struct_test.sh` covering determinism, alphabet constraints, balanced PK-free structures, and allowed base-pair validation.
- Files changed: `test/tools/gen_random_seq_struct.py`, `test/tools/gen_random_seq_struct_test.sh`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/004.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Building structures via bounded recursive expansion of the target grammar keeps outputs naturally pseudoknot-free without post-fix normalization.
  - Assigning paired nucleotides from an explicit allowed-pair set is simpler and more robust than trying to repair invalid pairs after random sequence generation.
---

## 2026-02-13 - 005
- What was implemented: Added `test/tools/build_density2_cli_baseline.sh` to capture CLI baseline TSV from mandatory `test/multi.secstruct` records plus deterministic random cases, and generated `test/baselines/fixed_energy_cli/density2_mfe.tsv` with 152 compared rows (`>=100`).
- Files changed: `test/tools/build_density2_cli_baseline.sh`, `test/baselines/fixed_energy_cli/density2_mfe.tsv`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/005.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Grammar-random structures can trigger frequent CLI crashes in this codebase; using random sequence assignment over known valid `pk_free` seed structures provides stable, reproducible coverage for baseline expansion.
  - Baseline capture should explicitly enforce `compared >= 100` in-script so data sufficiency is guaranteed before downstream alignment gates run.
---

## 2026-02-13 - 006
- What was implemented: Added source-registered alignment gate test `api_cli_density2_energy_alignment` that replays baseline rows through `CParty -d2 -r`, compares structure/energy with tolerances, prints `alignment_compared/alignment_mismatched/skipped/finite_rate`, and fails when `alignment_compared=0`.
- Files changed: `CMakeLists.txt`, `test/api_cli_density2_energy_alignment_test.cc`, `documents/fixed_energy_cli_alignment_report.md`, `documents/ralph-loop/prd.json`, `documents/ralph-loop/audit/006.md`, `documents/ralph-loop/progress.txt`
- **Learnings:**
  - Registering the gate as a compiled CTest target keeps anti-cheat checks source-controlled and reproducible in fresh-build runs.
  - Early-phase alignment gate value comes from reliable metric emission and zero-compare fail-fast, even before convergence to `alignment_mismatched=0`.
---
